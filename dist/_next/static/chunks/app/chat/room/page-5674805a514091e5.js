(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[269],{17692:(e,t,n)=>{Promise.resolve().then(n.bind(n,82888))},82888:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>z});var r=n(95155),o=n(12115),s=n(76046),a=n(35761),i=n(1297),l=n(4918),c=n(50226),d=n(58546),u=n(64559),g=n(60391),p=n(63592),m=n(19579),x=n(10810),h=n(894),f=n(2241),v=n(64954),y=n(6327),b=n(37419),j=n(34133),A=n(74247),C=n(11451),k=n(46805),w=n(71118),S=n(77159),R=n(85067),I=n(47235);function E(e){let{activeChat:t,onMenuClick:n}=e,o=(0,a.A)(),l=(0,i.A)(o.breakpoints.down("md")),{username:c,disconnect:d}=(0,I.FO)(),g=(0,s.useRouter)();return(0,r.jsx)(C.A,{position:"static",color:"default",elevation:0,sx:{borderBottom:"1px solid ".concat(o.palette.divider),bgcolor:"background.paper"},children:(0,r.jsxs)(k.A,{children:[l&&(0,r.jsx)(h.A,{edge:"start",color:"inherit","aria-label":"menu",sx:{mr:2},onClick:n,children:(0,r.jsx)(w.A,{})}),t?(0,r.jsxs)(j.P.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{type:"spring",stiffness:300},style:{display:"flex",alignItems:"center",width:"100%"},children:[(0,r.jsx)(u.A,{sx:{width:40,height:40,mr:2},children:t[0].toUpperCase()}),(0,r.jsxs)(p.A,{sx:{flexGrow:1},children:[(0,r.jsx)(x.A,{variant:"h6",component:"div",children:t}),(0,r.jsx)(x.A,{variant:"body2",color:"text.secondary",children:"Online"})]}),(0,r.jsxs)(p.A,{sx:{display:"flex",alignItems:"center",gap:1},children:[(0,r.jsx)(h.A,{children:(0,r.jsx)(S.A,{})}),(0,r.jsx)(h.A,{onClick:()=>{d(),g.push("/")},children:(0,r.jsx)(R.A,{})})]})]}):(0,r.jsx)(x.A,{variant:"h6",color:"text.secondary",sx:{ml:l?0:3},children:"ChitChat"})]})})}var M=n(78984),U=n(93965),D=n(28850),_=n(4323),F=n(11414);function O(e){let{privateChat:t,recipient:n,onTyping:s}=e,[a,i]=(0,o.useState)(""),[l,c]=(0,o.useState)(!1),{socket:d}=(0,I.FO)(),u=(0,o.useRef)(null),g=(0,o.useRef)(null),m=()=>{l||(c(!0),null==s||s(!0)),g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{c(!1),null==s||s(!1)},1e3)},f=()=>{if(!d){F.Ay.error("Socket connection lost. Please reconnect.");return}let e=a.trim();if(!e){F.Ay.error("Cannot send empty message");return}try{d.emit("message",{content:e,to:n}),i("")}catch(e){console.error("Error sending message:",e),F.Ay.error("Failed to send message. Please try again.")}},v=async e=>{var t;let r=null===(t=e.target.files)||void 0===t?void 0:t[0];if(r)try{let e=new FileReader;e.onload=()=>{let t=e.result;null==d||d.emit("message",{content:"Sent ".concat(r.type.startsWith("image/")?"an image":"a file",": ").concat(r.name),to:n,attachment:{type:r.type,name:r.name,data:t}})},e.readAsDataURL(r)}catch(e){console.error("Error reading file:",e)}};return(0,r.jsxs)(p.A,{component:j.P.div,initial:{y:20,opacity:0},animate:{y:0,opacity:1},sx:{display:"flex",gap:1,alignItems:"flex-end",p:2,bgcolor:"background.paper",borderTop:"1px solid",borderColor:"divider"},children:[t&&!n&&(0,r.jsx)(x.A,{variant:"body2",sx:{flex:1,color:"text.secondary",textAlign:"center"},children:"Select a user to start private chat"}),(!t||n)&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("input",{type:"file",ref:u,onChange:v,style:{display:"none"},accept:"image/*,video/*,audio/*"}),(0,r.jsx)(M.A,{title:"Attach file",children:(0,r.jsx)(h.A,{onClick:()=>{var e;return null===(e=u.current)||void 0===e?void 0:e.click()},sx:{color:"text.secondary"},children:(0,r.jsx)(D.A,{})})}),(0,r.jsx)(U.A,{fullWidth:!0,multiline:!0,maxRows:4,value:a,onChange:e=>{i(e.target.value),m()},onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),f())},placeholder:t?"Message ".concat(n):"Type a message",sx:{"& .MuiOutlinedInput-root":{borderRadius:3}}}),(0,r.jsx)(h.A,{onClick:f,disabled:!a.trim(),sx:{bgcolor:"primary.main",color:"primary.contrastText","&:hover":{bgcolor:"primary.dark"},"&.Mui-disabled":{bgcolor:"action.disabledBackground",color:"action.disabled"}},children:(0,r.jsx)(_.A,{})})]})]})}var P=n(89142),T=n(51239);let N=["\uD83D\uDC4D","❤️","\uD83D\uDE02","\uD83D\uDE2E","\uD83D\uDE22"],L=(0,P.Ay)(p.A,{shouldForwardProp:e=>"isOwnMessage"!==e})(e=>{let{theme:t,isOwnMessage:n}=e;return{maxWidth:"90%",width:"auto",padding:t.spacing(1.5),borderRadius:t.spacing(2),position:"relative",display:"inline-flex",wordBreak:"break-word",overflowWrap:"break-word",alignItems:"center",justifyContent:"flex-start",gap:t.spacing(1),...n?{backgroundColor:t.palette.primary.light,color:t.palette.primary.contrastText,borderBottomRightRadius:t.spacing(1),boxShadow:"0 4px 6px ".concat((0,T.a)(t.palette.primary.light,.3))}:{backgroundColor:t.palette.grey[200],color:t.palette.text.primary,borderBottomLeftRadius:t.spacing(1),boxShadow:"0 4px 6px ".concat((0,T.a)(t.palette.grey[300],.3))},"&::before":{content:'""',position:"absolute",bottom:0,...n?{right:"-".concat(t.spacing(2))}:{left:"-".concat(t.spacing(2))},width:0,height:0,borderStyle:"solid",borderWidth:"0 0 ".concat(t.spacing(2)," ").concat(t.spacing(2)),...n?{borderColor:"transparent transparent ".concat(t.palette.primary.light," transparent")}:{borderColor:"transparent transparent ".concat(t.palette.grey[200]," transparent")}}}});(0,P.Ay)(h.A)(e=>{let{theme:t}=e;return{transition:t.transitions.create(["transform","background-color"],{duration:t.transitions.duration.short}),"&:hover":{transform:"scale(1.2)",backgroundColor:t.palette.action.hover},"&:active":{transform:"scale(0.9)"}}});let B=e=>{let{message:t,isOwnMessage:n,currentUser:s}=e,[i,l]=(0,o.useState)(!1),{socket:c,messages:d,setMessages:u,username:g}=(0,I.cJ)(),m=(0,a.A)();(0,o.useEffect)(()=>{console.log("ChatMessage Component - Full Message Object:",{id:t.id,content:t.content,reactions:t.reactions,timestamp:t.timestamp,username:t.username})},[t]),(0,o.useEffect)(()=>{var e;console.log("ChatMessage: Reaction State Changed",{messageId:t.id,reactions:t.reactions,reactionsLength:null===(e=t.reactions)||void 0===e?void 0:e.length,messageContent:t.content})},[t.reactions]);let f=e=>{if(console.log("Reaction Click - Detailed",{messageId:t.id,emoji:e,messageContent:t.content,currentReactions:t.reactions}),!c||!g){console.error("Reaction Failed - Detailed",{socketAvailable:!!c,username:g,messageId:t.id}),F.Ay.error("Unable to add reaction. Please log in again.");return}try{let n;let r=t.reactions||[],o=r.findIndex(t=>t.emoji===e&&t.username===g);n=-1!==o?r.filter((e,t)=>t!==o):[...r,{emoji:e,username:g}],console.log("Reaction Update - Optimistic",{messageId:t.id,emoji:e,username:g,currentReactions:r,updatedReactions:n}),u(e=>e.map(e=>e.id===t.id?{...e,reactions:n}:e)),c.emit("add_reaction",{messageId:t.id,emoji:e,username:g})}catch(n){console.error("Reaction Error - Detailed",{messageId:t.id,emoji:e,username:g,error:n instanceof Error?n.message:n}),F.Ay.error("Failed to add reaction. Please try again.")}};return(0,r.jsxs)(p.A,{sx:{display:"flex",flexDirection:"column",alignItems:n?"flex-end":"flex-start",width:"100%",marginBottom:m.spacing(2),px:m.spacing(2)},onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1),children:[(()=>{var e;console.log("Rendering Reaction Panel - Detailed",{messageId:t.id,messageContent:t.content,reactions:t.reactions,reactionsLength:null===(e=t.reactions)||void 0===e?void 0:e.length,hasReactions:t.reactions&&t.reactions.length>0});let o=t.reactions||[];if(0===o.length)return console.log("No reactions to render for message",t.id),null;let s=o.reduce((e,t)=>(e[t.emoji]=(e[t.emoji]||0)+1,e),{});return console.log("Reaction Counts Breakdown",{messageId:t.id,reactionCounts:s,reactionDetails:o}),(0,r.jsx)(p.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",gap:m.spacing(1),backgroundColor:m.palette.background.paper,borderRadius:m.spacing(2),padding:m.spacing(.5),boxShadow:m.shadows[1],alignSelf:n?"flex-end":"flex-start",maxWidth:"90%"},children:Object.entries(s).map(e=>{let[t,n]=e;return(0,r.jsx)(M.A,{title:"".concat(n," reaction").concat(n>1?"s":""),children:(0,r.jsxs)(x.A,{variant:"caption",sx:{display:"flex",alignItems:"center"},children:[t," ",n>1&&n]})},t)})})})(),(0,r.jsx)(L,{isOwnMessage:n,children:(0,r.jsx)(x.A,{variant:"body2",children:t.content})}),(0,r.jsx)(x.A,{variant:"caption",color:"text.secondary",sx:{marginTop:m.spacing(.5),alignSelf:n?"flex-end":"flex-start"},children:(e=>{let t=Math.floor((Date.now()-e)/6e4),n=Math.floor(t/60);return n>0?"".concat(n," hr ago"):"".concat(t," min ago")})(t.timestamp)}),(0,r.jsx)(A.N,{children:i&&(0,r.jsx)(j.P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},transition:{type:"spring",stiffness:300,damping:20},style:{display:"flex",gap:m.spacing(.5),marginTop:m.spacing(.5),alignSelf:n?"flex-end":"flex-start",zIndex:10},children:N.map(e=>(0,r.jsx)(j.P.div,{whileHover:{scale:1.1},whileTap:{scale:.9},children:(0,r.jsx)(h.A,{onClick:()=>f(e),sx:{fontSize:"1rem",padding:m.spacing(.5),backgroundColor:m.palette.background.paper,"&:hover":{backgroundColor:m.palette.action.hover}},children:e})},e))})})]})};function W(){let{socket:e,username:t,onlineUsers:n,messages:s,selectedUser:C}=(0,I.cJ)(),[k,w]=(0,o.useState)(null),[S,R]=(0,o.useState)(!1),M=(0,o.useRef)(null),U=(0,a.A)(),D=(0,i.A)(U.breakpoints.down("md")),_=()=>{var e;null===(e=M.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};return(0,o.useEffect)(()=>{_()},[s]),(0,r.jsxs)(p.A,{sx:{display:"flex",height:"100vh",bgcolor:"background.default"},children:[(0,r.jsxs)(m.Ay,{variant:D?"temporary":"permanent",open:!D||S,onClose:()=>R(!1),sx:{width:300,flexShrink:0,"& .MuiDrawer-paper":{width:300,boxSizing:"border-box",bgcolor:"background.paper",borderRight:"1px solid ".concat(U.palette.divider)}},children:[(0,r.jsxs)(p.A,{sx:{display:"flex",alignItems:"center",p:2,justifyContent:"space-between"},children:[(0,r.jsxs)(x.A,{variant:"h6",sx:{display:"flex",alignItems:"center"},children:[(0,r.jsx)(v.A,{sx:{mr:1}})," Online Users"]}),D&&(0,r.jsx)(h.A,{onClick:()=>R(!1),children:(0,r.jsx)(y.A,{})})]}),(0,r.jsx)(f.A,{}),(0,r.jsx)(l.A,{children:n.filter(e=>e!==t).map(e=>(0,r.jsx)(j.P.div,{whileHover:{scale:1.05},whileTap:{scale:.95},children:(0,r.jsxs)(c.Ay,{button:!0,onClick:()=>{w(e),D&&R(!1)},selected:k===e,children:[(0,r.jsx)(d.A,{children:(0,r.jsx)(u.A,{children:e.charAt(0).toUpperCase()})}),(0,r.jsx)(g.A,{primary:e})]})},e))})]}),(0,r.jsxs)(p.A,{sx:{flexGrow:1,display:"flex",flexDirection:"column",position:"relative",overflow:"hidden"},children:[(0,r.jsx)(E,{activeChat:k,onMenuClick:()=>R(!0)}),(0,r.jsxs)(p.A,{sx:{flexGrow:1,overflowY:"auto",py:2,bgcolor:"background.default",display:"flex",flexDirection:"column"},children:[k?(0,r.jsx)(A.N,{children:(()=>{let e=s.filter(e=>{let n=!e.private,r=e.username===t,o=e.to===t,s=e.to===k,a=e.username===k;return console.log("Message Filtering:",{message:e,username:t,activeChat:k,isPublicMessage:n,isSentByCurrentUser:r,isSentToCurrentUser:o,isSentToActiveChat:s,isSentByActiveChat:a}),n||e.private&&(r&&s||a&&o)});return console.log("Filtered Messages:",e),e.map((e,n)=>{let o=e.username===t;return console.log("Rendering Message:",{username:e.username,currentUser:t,isOwnMessage:o}),(0,r.jsx)(B,{message:e,isOwnMessage:o,currentUser:t},e.id)})})()}):(0,r.jsxs)(p.A,{sx:{flexGrow:1,display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"column"},children:[(0,r.jsx)(b.A,{sx:{fontSize:100,color:"text.secondary",mb:2}}),(0,r.jsx)(x.A,{variant:"h6",color:"text.secondary",children:"Select a user to start chatting"})]}),(0,r.jsx)("div",{ref:M})]}),k&&(0,r.jsx)(O,{privateChat:!0,recipient:k})]})]})}var J=n(96854);function z(){let e=(0,s.useRouter)(),{username:t,socket:n}=(0,I.FO)(),[a,i]=(0,o.useState)(!0);return((0,o.useEffect)(()=>{(async()=>{await new Promise(e=>setTimeout(e,100)),t&&n?i(!1):(console.log("No username or socket, redirecting to chat page"),e.replace("/chat"))})()},[t,n,e]),a)?(0,r.jsx)(p.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:(0,r.jsx)(J.A,{})}):t&&n?(0,r.jsx)(W,{}):null}},47235:(e,t,n)=>{"use strict";n.d(t,{FI:()=>l,FO:()=>c,cJ:()=>d});var r=n(95155),o=n(12115),s=n(71319),a=n(11414);let i="https://chitchat-socket-server.onrender.com",l=e=>{let{children:t}=e,[n,l]=(0,o.useState)(null),[c,d]=(0,o.useState)(""),g=(0,o.useRef)(""),[p,m]=(0,o.useState)([]),[x,h]=(0,o.useState)(null),[f,v]=(0,o.useState)([]),[y,b]=(0,o.useState)(null);(0,o.useEffect)(()=>{g.current=c},[c]);let j=(0,o.useCallback)(()=>{n&&n.disconnect();let e=g.current||localStorage.getItem("username");if(console.log("Connection Attempt Details:",{usernameRefCurrent:g.current,localStorageUsername:localStorage.getItem("username"),finalUsername:e}),!e)return console.error("No username available for connection"),a.oR.error("Username is required"),!1;try{console.log("Attempting to connect with username:",e),console.log("Socket URL:",i);let t=(0,s.io)(i,{auth:{username:e},transports:["websocket","polling"],reconnection:!0,reconnectionAttempts:10,reconnectionDelay:1e3,timeout:15e3,forceNew:!0,withCredentials:!1});return t.on("connect",()=>(console.log("Detailed Connection Success:",{id:t.id,connected:t.connected,username:t.auth.username||e,transportUsed:t.io.engine.transport.name}),d(e),g.current=e,localStorage.setItem("username",e),t.connected||(console.error("Socket reports not connected despite connect event"),a.oR.error("Connection established but not fully connected")),l(t),window.socket=t,!0)),t.on("connect_error",e=>(console.error("Comprehensive Connection Error:",{message:e.message,name:e.name,stack:e.stack}),a.oR.error("Connection failed: ".concat(e.message,". Check server status.")),l(null),window.socket=null,!1)),!0}catch(e){return console.error("Fatal socket connection error:",e),a.oR.error("Failed to establish socket connection"),!1}},[n]),A=(0,o.useCallback)(()=>{n&&(console.log("Disconnecting socket:",{socketId:n.id,currentUsername:c}),n.disconnect(),l(null),window.socket=null)},[n,c]),C=(0,o.useCallback)(e=>{b(e),h(e)},[]),k=(0,o.useCallback)(()=>{n&&n.emit("requestOnlineUsers")},[n]);return(0,o.useEffect)(()=>{if(!n)return;let e=["connect","disconnect","message","message_updated","previousMessages","reaction_error"];e.forEach(e=>{n.on(e,t=>{console.log("SOCKET EVENT: ".concat(e),{eventData:t,timestamp:new Date().toISOString()})})}),n.on("connect_error",e=>{console.error("Socket Connection Error:",e)}),n.on("reaction_error",e=>{console.error("Reaction Error:",e),a.oR.error("Failed to process reaction. Please try again.")});let t=e=>{console.log("Context: Received online users:",e),v(e)},r=e=>{console.log("Context: User left:",e),v(t=>t.filter(t=>t!==e))},o=e=>{console.log("Context: Received online users from explicit request:",e),v(e)},s=e=>{console.log("Context: Received previous messages:",e.length),m(e)},i=e=>{console.log("Context: Received new message:",{username:e.username,to:e.to,private:e.private,content:e.content}),m(t=>t.some(t=>t.id===e.id)?t:e.private?e.username===c&&e.to===y||e.username===y&&e.to===c?[...t,e]:t:[...t,e])},l=e=>{console.error("Context: Message sending error:",e),a.oR.error(e)},d=e=>{var t;console.log("Context: Detailed Message Update",{event:"message_updated",messageId:e.id,content:e.content,reactions:e.reactions,reactionsLength:null===(t=e.reactions)||void 0===t?void 0:t.length}),m(t=>{let n=t.findIndex(t=>t.id===e.id);if(-1===n)return console.warn("Context: Updated message not found",{updatedMessageId:e.id}),t;let r=[...t];return r[n]={...t[n],...e,reactions:e.reactions||[]},r})},u=e=>{console.error("Context: Reaction error:",e),a.oR.error("Failed to add reaction: ".concat(e.error))};return n.on("userJoined",t),n.on("userLeft",r),n.on("onlineUsers",o),n.on("previousMessages",s),n.on("message",i),n.on("message_error",l),n.on("message_updated",d),n.on("reaction_error",u),()=>{e.forEach(e=>{n.off(e)}),n.off("userJoined",t),n.off("userLeft",r),n.off("onlineUsers",o),n.off("previousMessages",s),n.off("message",i),n.off("message_error",l),n.off("message_updated",d),n.off("reaction_error",u)}},[n,c,y]),(0,r.jsx)(u.Provider,{value:{socket:n,username:c,setUsername:e=>{console.log("Setting username in context:",e),d(e),g.current=e},messages:p,setMessages:m,targetUsername:x,setTargetUsername:h,connect:j,disconnect:A,onlineUsers:f,selectedUser:y,selectUser:C,requestOnlineUsers:k},children:t})},c=()=>{let e=(0,o.useContext)(u);if(!e)throw Error("useSocket must be used within a SocketProvider");return e},d=()=>{let e=(0,o.useContext)(u);if(!e)throw Error("useSocketContext must be used within a SocketProvider");return e},u=(0,o.createContext)(void 0)}},e=>{var t=t=>e(e.s=t);e.O(0,[943,766,878,394,712,600,198,770,441,517,358],()=>t(17692)),_N_E=e.O()}]);